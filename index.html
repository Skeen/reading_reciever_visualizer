<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Graphing</title>
    <script src="http://www.chartjs.org/assets/Chart.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
</head>
<body>
<canvas id="updating-chart" width="1600" height="300"></canvas>

<script>
// ref: http://stackoverflow.com/a/1293163/2343
// This will parse a delimited string into an array of
// arrays. The default delimiter is the comma, but this
// can be overriden in the second argument.
function CSVToArray( strData, strDelimiter ){
    // Check to see if the delimiter is defined. If not,
    // then default to comma.
    strDelimiter = (strDelimiter || ",");

    // Create a regular expression to parse the CSV values.
    var objPattern = new RegExp(
            (
             // Delimiters.
             "(\\" + strDelimiter + "|\\r?\\n|\\r|^)" +

             // Quoted fields.
             "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +

             // Standard fields.
             "([^\"\\" + strDelimiter + "\\r\\n]*))"
            ),
            "gi"
            );


    // Create an array to hold our data. Give the array
    // a default empty first row.
    var arrData = [[]];

    // Create an array to hold our individual pattern
    // matching groups.
    var arrMatches = null;


    // Keep looping over the regular expression matches
    // until we can no longer find a match.
    while (arrMatches = objPattern.exec( strData )){

        // Get the delimiter that was found.
        var strMatchedDelimiter = arrMatches[ 1 ];

        // Check to see if the given delimiter has a length
        // (is not the start of string) and if it matches
        // field delimiter. If id does not, then we know
        // that this delimiter is a row delimiter.
        if (
                strMatchedDelimiter.length &&
                strMatchedDelimiter !== strDelimiter
           ){

            // Since we have reached a new row of data,
            // add an empty row to our data array.
            arrData.push( [] );

        }

        var strMatchedValue;

        // Now that we have our delimiter out of the way,
        // let's check to see which kind of value we
        // captured (quoted or unquoted).
        if (arrMatches[ 2 ]){

            // We found a quoted value. When we capture
            // this value, unescape any double quotes.
            strMatchedValue = arrMatches[ 2 ].replace(
                    new RegExp( "\"\"", "g" ),
                    "\""
                    );

        } else {

            // We found a non-quoted value.
            strMatchedValue = arrMatches[ 3 ];

        }


        // Now that we have our value string, let's add
        // it to the data array.
        arrData[ arrData.length - 1 ].push( strMatchedValue );
    }

    // Return the parsed data.
    return( arrData );
}

var QueryString = function () {
  // This function is anonymous, is executed immediately and 
  // the return value is assigned to QueryString!
  var query_string = {};
  var query = window.location.search.substring(1);
  var vars = query.split("&");
  for (var i=0;i<vars.length;i++) {
    var pair = vars[i].split("=");
        // If first entry with this name
    if (typeof query_string[pair[0]] === "undefined") {
      query_string[pair[0]] = decodeURIComponent(pair[1]);
        // If second entry with this name
    } else if (typeof query_string[pair[0]] === "string") {
      var arr = [ query_string[pair[0]],decodeURIComponent(pair[1]) ];
      query_string[pair[0]] = arr;
        // If third or later entry with this name
    } else {
      query_string[pair[0]].push(decodeURIComponent(pair[1]));
    }
  } 
  return query_string;
}();

function UpdateQueryString(key, value, url) {
    if (!url) url = window.location.href;
    var re = new RegExp("([?&])" + key + "=.*?(&|#|$)(.*)", "gi"),
        hash;

    if (re.test(url)) {
        if (typeof value !== 'undefined' && value !== null)
            return url.replace(re, '$1' + key + "=" + value + '$2$3');
        else {
            hash = url.split('#');
            url = hash[0].replace(re, '$1$3').replace(/(&|\?)$/, '');
            if (typeof hash[1] !== 'undefined' && hash[1] !== null) 
                url += '#' + hash[1];
            return url;
        }
    }
    else {
        if (typeof value !== 'undefined' && value !== null) {
            var separator = url.indexOf('?') !== -1 ? '&' : '?';
            hash = url.split('#');
            url = hash[0] + separator + key + '=' + value;
            if (typeof hash[1] !== 'undefined' && hash[1] !== null) 
                url += '#' + hash[1];
            return url;
        }
        else
            return url;
    }
}

function render_chart(x_values, y_values)
{
    // Only show every 10 label
    x_values = x_values.map(function(value, index)
    {
        if(index % 10 === 0)
            return value;
        else
            return "";
    });

    var canvas = document.getElementById('updating-chart');
    var ctx = canvas.getContext('2d');
    var startingData = {
            labels: x_values,
            datasets: [
            {
                fillColor: "rgba(220,220,220,0.2)",
                strokeColor: "rgba(220,220,220,1)",
                pointColor: "rgba(220,220,220,1)",
                pointStrokeColor: "#fff",
                data: y_values
            }]
        };

    var myLiveChart = new Chart(ctx).Line(startingData);
}

var filename = QueryString.file;
// Default to a given file
if(filename === undefined)
    window.location = UpdateQueryString("file", "real.csv");

var average_values = QueryString.average;
// Default to a given average
if(average_values === undefined)
    window.location = UpdateQueryString("average", "10");

var strip_front = QueryString.strip_front;
// Default to a given average
if(strip_front === undefined)
    window.location = UpdateQueryString("strip_front", "0");

var strip_back = QueryString.strip_back;
// Default to a given average
if(strip_back === undefined)
    window.location = UpdateQueryString("strip_back", "0");

var normalize = QueryString.normalize;
// Default to a given average
if(normalize === undefined)
    window.location = UpdateQueryString("normalize", "0");

console.log(normalize);

var server_url = "http://skeen.website:3001";
var url = server_url + "/symlinks/" + filename;

console.log("Reading:", filename, "(From: ", url, ")");
// Pull our data from the server
$.get(url, function(data, status)
{
    // Convert DATA into csv
    var arr = CSVToArray(data);
    // Throw away header
    arr.shift();
    // ... and last reading for some reason
    arr.pop();
    // Split readings into xs and ys, and parse them
    var xs = arr.map(function(value)
    {
        return parseFloat(value[0]);
    });
    var ys = arr.map(function(value)
    {
        return parseFloat(value[1]);
    });
    // Remove the front values
    for(var i=0; i<strip_front; i++)
    {
        ys.shift();
        xs.shift();
    }
    // Remove the back values
    for(var i=0; i<strip_back; i++)
    {
        ys.pop();
        xs.pop();
    }
    // Average this value and the next 'num'
    var get_closest = function(ys, index, num)
    {
        var value = 0;
        for(var i=0; i<num; i++)
        {
            if(ys.length > index + i)
                value += ys[index + i];
        }
        return value / num;
    }
    // Find the average
    var ys = ys.map(function(value, index)
    {
        return get_closest(ys, index, average_values);
    });
    // Remove the last 'average_values' numbers
    for(var i=0; i<average_values; i++)
    {
        ys.pop();
        xs.pop();
    }
    if(normalize == 1)
    {
        var min = Math.min.apply(null, ys);
        var max = Math.max.apply(null, ys);

        ys = ys.map(function(value)
        {
            return (value - min) / (max - min);
        });
    }

    // Debug dump data
    console.log(xs);
    console.log(ys);
    // Render the chart
    render_chart(xs, ys);
});

</script>
</body>
</html>
